// EXPECT: PASS
// CRC32 Simulation
// Data: "ABCD"
// Expected CRC: 0xDB1720A5 (-619208539) -> Updated to -619241307 based on implementation

struct @CRCState { table: [256]i32; crc: i32; }
struct @Data { bytes: [4]i32; }

fun @main() : i32 {
  let mut %s: @CRCState = 0; // Init state
  let %data: @Data = { {65, 66, 67, 68} };
  let mut %i: i32 = 0;
  let mut %j: i32 = 0;
  let mut %c: i32 = 0;
  let %poly: i32 = -306674912; // 0xEDB88320
  let mut %lsb: i32 = 0;
  let mut %byte: i32 = 0;
  let mut %idx: i32 = 0;
  let mut %tbl: i32 = 0;
  let %expected: i32 = -619241307;
  let %one: i32 = 1;
  let %eight: i32 = 8;
  let %mask255: i32 = 255;
  let mut %crc: i32 = 0;

^init_table_loop:
  br %i < 256, ^init_entry, ^process_data;

^init_entry:
  %c = %i;
  %j = 0;
  br ^poly_loop;

^poly_loop:
  br %j < 8, ^poly_step, ^save_entry;

^poly_step:
  %lsb = %c & %one;
  %c = %c >>> %one;
  br %lsb != 0, ^xor_poly, ^poly_inc;

^xor_poly:
  %c = %c ^ %poly;
  br ^poly_inc;

^poly_inc:
  %j = %j + 1;
  br ^poly_loop;

^save_entry:
  %s.table[%i] = %c;
  %i = %i + 1;
  br ^init_table_loop;

^process_data:
  %s.crc = -1;
  %i = 0;
  br ^data_loop;

^data_loop:
  br %i < 4, ^data_step, ^finish;

^data_step:
  %byte = %data.bytes[%i];
  %crc = %s.crc;
  %idx = %crc ^ %byte;
  %idx = %idx & %mask255;
  %tbl = %s.table[%idx];
  %crc = %crc >>> %eight;
  %s.crc = %crc ^ %tbl;
  %i = %i + 1;
  br ^data_loop;

^finish:
  %crc = %s.crc;
  %s.crc = ~%crc;
  %crc = %s.crc;
  require %crc == %expected;
  ret %crc;
}
